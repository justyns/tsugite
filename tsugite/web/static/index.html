<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsugite Web UI</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß tsugite</h1>
            <p class="subtitle">Micro-agent runner</p>
        </header>

        <main>
            <div class="input-section">
                <div class="form-group">
                    <label for="agent">Agent</label>
                    <select id="agent" name="agent_path"
                            hx-get="/api/agents"
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option>Loading agents...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prompt">Prompt</label>
                    <textarea id="prompt" name="prompt" rows="4"
                              placeholder="Enter your task here..."></textarea>
                </div>

                <div class="form-group">
                    <label for="model">Model (optional)</label>
                    <input type="text" id="model" name="model"
                           placeholder="e.g., openai:gpt-4o-mini">
                </div>

                <button id="run-btn"
                        hx-post="/api/run"
                        hx-include="#agent,#prompt,#model"
                        hx-swap="none"
                        onclick="clearOutput()">
                    Run Agent
                </button>
            </div>

            <div class="output-section">
                <h2>Output</h2>
                <div id="output" class="output-container">
                    <div class="empty-state">Run an agent to see output here</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Clear output on new run
        function clearOutput() {
            document.getElementById('output').innerHTML = '<div class="loading">Starting agent...</div>';
        }

        // Handle agent list response
        htmx.on('#agent', 'htmx:afterSwap', function(evt) {
            const response = JSON.parse(evt.detail.xhr.response);
            const select = document.getElementById('agent');
            select.innerHTML = '';

            if (response.agents.length === 0) {
                select.innerHTML = '<option>No agents found</option>';
                return;
            }

            response.agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.full_path;
                option.textContent = `${agent.name} (${agent.path})`;
                select.appendChild(option);
            });
        });

        // Handle run response - use afterRequest since we're not swapping content
        htmx.on('#run-btn', 'htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                const response = JSON.parse(evt.detail.xhr.response);
                const executionId = response.execution_id;

                // Connect to SSE stream
                connectSSE(executionId);
            } else {
                document.getElementById('output').innerHTML =
                    '<div class="error">Failed to start agent: ' + evt.detail.xhr.statusText + '</div>';
            }
        });

        function connectSSE(executionId) {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Connecting to agent...</div>';

            console.log('Connecting to SSE stream:', executionId);
            const eventSource = new EventSource(`/api/stream/${executionId}`);

            eventSource.addEventListener('task_start', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('üöÄ Task Started', data.task, 'task-start');
            });

            eventSource.addEventListener('step_start', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('ü§î Step ' + data.step, 'Thinking...', 'step');
            });

            eventSource.addEventListener('code_execution', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('‚ö° Executing Code', data.code, 'code', true);
            });

            eventSource.addEventListener('tool_call', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('üîß Tool Call', data.content, 'tool');
            });

            eventSource.addEventListener('observation', function(e) {
                const data = JSON.parse(e.data);
                const isError = data.observation.toLowerCase().includes('error');
                appendEvent('üí° Observation', data.observation, isError ? 'error' : 'observation');
            });

            eventSource.addEventListener('execution_result', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('üì§ Output', data.content, 'output');
            });

            eventSource.addEventListener('final_answer', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('‚úÖ Final Answer', data.answer, 'final-answer');
            });

            eventSource.addEventListener('error', function(e) {
                const data = JSON.parse(e.data);
                appendEvent('‚ùå Error', data.error, 'error');
            });

            eventSource.addEventListener('done', function(e) {
                console.log('SSE stream done');
                eventSource.close();
            });

            eventSource.onopen = function(e) {
                console.log('SSE connection opened');
                output.innerHTML = '';  // Clear "Connecting..." message
            };

            eventSource.onerror = function(e) {
                console.error('SSE error:', e);
                appendEvent('‚ùå Connection Error', 'Lost connection to server', 'error');
                eventSource.close();
            };
        }

        function appendEvent(title, content, className, isCode = false) {
            const output = document.getElementById('output');
            const event = document.createElement('div');
            event.className = `event ${className}`;

            const titleEl = document.createElement('div');
            titleEl.className = 'event-title';
            titleEl.textContent = title;
            event.appendChild(titleEl);

            const contentEl = document.createElement('div');
            contentEl.className = 'event-content';

            if (isCode) {
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                code.textContent = content;
                pre.appendChild(code);
                contentEl.appendChild(pre);
            } else {
                contentEl.textContent = content;
            }

            event.appendChild(contentEl);
            output.appendChild(event);

            // Auto-scroll
            output.scrollTop = output.scrollHeight;
        }
    </script>
</body>
</html>
