<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tsugite</title>
<link rel="stylesheet" href="/static/css/theme.css">
<link rel="stylesheet" href="/static/css/styles.css">
<script type="module" src="/static/js/app.js"></script>
</head>
<body x-data :data-theme="$store.app.theme">

<nav>
  <h1>Tsugite</h1>
  <div class="tab-bar">
    <template x-for="tab in ['dashboard','chat','agents','schedules','history','webhooks']" :key="tab">
      <button @click="$store.app.view = tab; location.hash = tab"
              :class="{ active: $store.app.view === tab }"
              x-text="tab[0].toUpperCase() + tab.slice(1)"></button>
    </template>
  </div>
  <span class="spacer"></span>
  <select x-model="$store.app.selectedAgent">
    <template x-for="a in $store.app.agents" :key="a.name">
      <option :value="a.name" x-text="a.name"></option>
    </template>
  </select>
  <button id="settings-btn" @click="$store.app.showSettings = true">Settings</button>
</nav>

<main>
  <!-- Dashboard -->
  <div class="view" x-show="$store.app.view === 'dashboard'" x-data="dashboardView" x-cloak>
    <div class="view-scroll">
      <template x-if="loading">
        <div class="empty-state"><span class="spinner"></span> Loading...</div>
      </template>
      <template x-if="error">
        <div class="msg error" x-text="error" style="margin:16px auto"></div>
      </template>
      <template x-if="!loading && !error">
        <div>
          <div class="section-header"><h2>Agents</h2></div>
          <div class="card-grid">
            <template x-for="card in agentCards" :key="card.name">
              <div class="card">
                <h3>
                  <span x-text="card.name"></span>
                  <template x-if="card.running_tasks > 0">
                    <span class="badge badge-accent" style="margin-left:8px;font-size:11px"><span class="spinner" style="width:10px;height:10px;margin-right:4px"></span> running</span>
                  </template>
                </h3>
                <div class="card-meta">
                  <div>Model: <span x-text="card.model || 'unknown'"></span></div>
                  <div>Context: <span x-text="contextDisplay(card)"></span></div>
                  <div>Messages: <span x-text="card.message_count || 0"></span></div>
                </div>
              </div>
            </template>
          </div>
          <template x-if="upcomingSchedules.length > 0">
            <div style="margin-top:24px">
              <div class="section-header"><h2>Upcoming Schedules</h2></div>
              <table class="data-table">
                <thead><tr><th>ID</th><th>Agent</th><th>Next Run</th></tr></thead>
                <tbody>
                  <template x-for="s in upcomingSchedules" :key="s.id">
                    <tr>
                      <td x-text="s.id"></td>
                      <td x-text="s.agent"></td>
                      <td x-text="formatDate(s.next_run)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>

  <!-- Chat -->
  <div class="view" x-show="$store.app.view === 'chat'" x-data="chatView" x-cloak>
    <div id="messages" x-ref="messages">
      <template x-for="(msg, i) in messages" :key="i">
        <div>
          <template x-if="msg.type === 'compaction'">
            <div class="history-sep">
              <template x-if="msg.summary">
                <details>
                  <summary>session compacted</summary>
                  <div class="msg agent compaction-body" x-html="renderHtml(msg.summary)"></div>
                </details>
              </template>
              <template x-if="!msg.summary">
                <span>session compacted</span>
              </template>
            </div>
          </template>
          <template x-if="msg.type === 'separator'">
            <div class="history-sep" x-text="msg.text"></div>
          </template>
          <template x-if="msg.type === 'user'">
            <div class="msg user" x-html="renderHtml(msg.text)"></div>
          </template>
          <template x-if="msg.type === 'agent'">
            <div class="msg agent" x-html="renderHtml(msg.text)"></div>
          </template>
          <template x-if="msg.type === 'error'">
            <div class="msg error" x-text="msg.text"></div>
          </template>
          <template x-if="msg.type === 'progress'">
            <div class="msg progress">
              <span class="spinner"></span>
              <span x-text="msg.statusText"></span>
              <ul class="tool-steps">
                <template x-for="(step, j) in msg.steps" :key="j">
                  <li x-html="step.html"></li>
                </template>
              </ul>
            </div>
          </template>
          <template x-if="msg.type === 'progress-done'">
            <div class="msg progress">
              <details>
                <summary class="tool-summary" x-text="progressSummaryText(msg)"></summary>
                <ul class="tool-steps">
                  <template x-for="(step, j) in msg.steps" :key="j">
                    <li x-html="step.html"></li>
                  </template>
                </ul>
              </details>
            </div>
          </template>
          <template x-if="msg.type === 'ask_user'">
            <div class="msg agent ask-user-form">
              <p><strong x-text="msg.question"></strong></p>
              <template x-if="msg.answered">
                <p class="ask-answered">Answered: <em x-text="msg.answer"></em></p>
              </template>
              <template x-if="!msg.answered && msg.questionType === 'yes_no'">
                <div class="ask-buttons">
                  <button @click="submitAskUser(i, 'yes')">Yes</button>
                  <button @click="submitAskUser(i, 'no')">No</button>
                </div>
              </template>
              <template x-if="!msg.answered && msg.questionType === 'choice'">
                <div class="ask-buttons">
                  <template x-for="opt in msg.options" :key="opt">
                    <button @click="submitAskUser(i, opt)" x-text="opt"></button>
                  </template>
                </div>
              </template>
              <template x-if="!msg.answered && msg.questionType === 'text'">
                <form class="ask-text" @submit.prevent="submitAskUser(i, msg.inputValue || '')">
                  <input type="text" x-model="msg.inputValue" placeholder="Type your answer..." autofocus>
                  <button type="submit">Send</button>
                </form>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>

    <div id="status-bar" x-show="statusParts.length > 0">
      <template x-for="(part, i) in statusParts" :key="i">
        <span>
          <span class="status-label" x-text="part.label + ':'"></span>
          <template x-if="part.isLink === 'attachments'">
            <span class="att-link" @click="openAttachments()" x-text="part.value"></span>
          </template>
          <template x-if="part.isLink === 'skills'">
            <span class="att-link" @click="showSkills = true" x-text="part.value"></span>
          </template>
          <template x-if="!part.isLink">
            <span x-text="part.value"></span>
          </template>
          <span style="opacity:0.3;margin:0 4px">|</span>
        </span>
      </template>
      <template x-if="compacting">
        <span><span class="spinner"></span> Compacting...</span>
      </template>
      <button class="btn-sm" x-show="!compacting" @click="compactSession()" :disabled="sending">Compact</button>
    </div>

    <div id="input-area">
      <textarea id="message-input" x-model="messageText" rows="1"
                placeholder="Send a message..." autofocus
                @keydown="onInputKeydown" @input="autoResize"></textarea>
      <button id="send-btn" @click="sendMessage()" :disabled="sending">Send</button>
    </div>

    <!-- Attachments modal -->
    <div class="modal-backdrop att-modal" :class="{ open: showAttachments }" @click.self="showAttachments = false">
      <div class="modal-content">
        <h2>Attachments</h2>
        <template x-if="attachments.length === 0">
          <p style="color:var(--muted);font-size:13px">No attachments</p>
        </template>
        <template x-for="att in attachments" :key="att.name">
          <div class="att-item" x-data="{ open: false }">
            <div class="att-header" @click="open = !open">
              <span class="att-name" x-text="att.name"></span>
              <span class="att-type" x-text="att.content_type + ' · ' + att.mime_type"></span>
            </div>
            <div class="att-body" x-show="open">
              <template x-if="att.content != null">
                <pre x-text="att.content"></pre>
              </template>
              <template x-if="att.content == null">
                <span style="color:var(--muted)" x-text="att.size_bytes != null ? att.size_bytes + ' bytes (binary)' : 'No content preview'"></span>
              </template>
            </div>
          </div>
        </template>
        <div class="modal-actions">
          <button class="btn-cancel" @click="showAttachments = false">Close</button>
        </div>
      </div>
    </div>

    <!-- Skills modal -->
    <div class="modal-backdrop att-modal" :class="{ open: showSkills }" @click.self="showSkills = false">
      <div class="modal-content">
        <h2>Loaded Skills</h2>
        <template x-if="loadedSkills.length === 0">
          <p style="color:var(--muted);font-size:13px">No skills loaded</p>
        </template>
        <template x-for="skill in loadedSkills" :key="skill.name">
          <div class="att-item">
            <div class="att-header">
              <span class="att-name" x-text="skill.name"></span>
              <span class="att-type" x-text="skill.description"></span>
            </div>
          </div>
        </template>
        <div class="modal-actions">
          <button class="btn-cancel" @click="showSkills = false">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Files -->
  <div class="view" x-show="$store.app.view === 'agents'" x-data="agentFileView" x-cloak>
    <div class="view-scroll" style="display:flex;gap:16px">
      <!-- File list -->
      <div style="width:280px;flex-shrink:0">
        <div class="section-header">
          <h2>Agent Files</h2>
          <select x-model="filter" style="font-size:12px;padding:2px 4px">
            <option value="all">All</option>
            <option value="project">Project</option>
            <option value="builtin">Builtin</option>
            <option value="global">Global</option>
          </select>
        </div>
        <template x-if="loading">
          <div class="empty-state"><span class="spinner"></span></div>
        </template>
        <template x-if="!loading && filteredFiles.length === 0">
          <div class="empty-state">No agent files found</div>
        </template>
        <div class="turn-list">
          <template x-for="file in filteredFiles" :key="file.path">
            <div class="turn-item" :class="{ active: selectedFile?.path === file.path }"
                 @click="selectFile(file)">
              <div>
                <span x-text="file.name"></span>
                <template x-if="file.readonly">
                  <span class="badge" style="font-size:10px;margin-left:4px">readonly</span>
                </template>
              </div>
              <div class="turn-meta" x-text="file.source + (file.description ? ' · ' + file.description : '')"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Editor -->
      <div style="flex:1;min-width:0;display:flex;flex-direction:column">
        <template x-if="!selectedFile">
          <div class="empty-state">Select an agent file to view</div>
        </template>
        <template x-if="selectedFile">
          <div style="display:flex;flex-direction:column;flex:1;min-height:0">
            <div class="section-header">
              <h2>
                <span x-text="selectedFile.name"></span>
                <template x-if="isDirty">
                  <span style="color:var(--accent);font-size:12px;margin-left:8px">unsaved</span>
                </template>
              </h2>
              <template x-if="!selectedFile.readonly">
                <button class="btn-sm" @click="save()" :disabled="saving || !isDirty"
                        x-text="saving ? 'Saving...' : 'Save'"></button>
              </template>
            </div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px" x-text="selectedFile.path"></div>
            <template x-if="error">
              <div class="msg error" x-text="error" style="margin-bottom:8px"></div>
            </template>
            <textarea x-model="content"
                      :readonly="selectedFile.readonly"
                      style="flex:1;min-height:300px;font-family:monospace;font-size:13px;resize:vertical;background:var(--surface0);color:var(--text);border:1px solid var(--surface2);border-radius:6px;padding:12px;tab-size:2"></textarea>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Schedules -->
  <div class="view" x-show="$store.app.view === 'schedules'" x-data="scheduleView" x-cloak>
    <div class="view-scroll">
      <div class="section-header">
        <h2>Schedules</h2>
        <button class="btn-sm" @click="showForm ? cancelForm() : (showForm = true)" x-text="showForm ? 'Cancel' : '+ New'"></button>
      </div>

      <template x-if="error">
        <div class="msg error" x-text="error" style="margin-bottom:16px"></div>
      </template>

      <!-- Create/Edit form -->
      <template x-if="showForm">
        <div class="card" style="margin-bottom:16px">
          <h3 x-text="formTitle" style="margin-bottom:12px"></h3>
          <div class="form-row">
            <div class="form-group">
              <label>ID</label>
              <input x-model="form.id" placeholder="my-schedule" :disabled="!!editingId">
            </div>
            <div class="form-group">
              <label>Agent</label>
              <select x-model="form.agent">
                <option value="">Select agent...</option>
                <template x-for="a in $store.app.agents" :key="a.name">
                  <option :value="a.name" x-text="a.name"></option>
                </template>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Prompt</label>
            <textarea x-model="form.prompt" rows="2" placeholder="Task for the agent..." style="resize:vertical"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Model</label>
              <input x-model="form.model" placeholder="e.g. openai:gpt-4o-mini">
            </div>
            <div class="form-group">
              <label>Agent File</label>
              <input x-model="form.agent_file" placeholder="e.g. my-agent.md">
            </div>
            <div class="form-group">
              <label>Max Turns</label>
              <input x-model="form.max_turns" type="number" min="1" placeholder="default">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select x-model="form.schedule_type">
                <option value="cron">Cron</option>
                <option value="once">Once</option>
              </select>
            </div>
            <div class="form-group" x-show="form.schedule_type === 'cron'">
              <label>Cron Expression</label>
              <input x-model="form.cron_expr" placeholder="0 9 * * *">
            </div>
            <div class="form-group" x-show="form.schedule_type === 'once'">
              <label>Run At (ISO)</label>
              <input x-model="form.run_at" type="datetime-local">
            </div>
            <div class="form-group">
              <label>Timezone</label>
              <input x-model="form.timezone" placeholder="UTC">
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-cancel" @click="cancelForm()">Cancel</button>
            <button class="btn-primary" @click="save()" x-text="editingId ? 'Update' : 'Create'"></button>
          </div>
        </div>
      </template>

      <template x-if="loading">
        <div class="empty-state"><span class="spinner"></span> Loading...</div>
      </template>

      <template x-if="!loading && schedules.length === 0">
        <div class="empty-state">No schedules configured</div>
      </template>

      <template x-if="!loading && schedules.length > 0">
        <table class="data-table">
          <thead><tr><th>ID</th><th>Agent</th><th>Model</th><th>Agent File</th><th>Type</th><th>Status</th><th>Next Run</th><th>Last Run</th><th>Actions</th></tr></thead>
          <tbody>
            <template x-for="s in schedules" :key="s.id">
              <tr>
                <td x-text="s.id"></td>
                <td x-text="s.agent"></td>
                <td x-text="s.model || '—'"></td>
                <td x-text="s.agent_file || '—'"></td>
                <td x-text="s.schedule_type"></td>
                <td><span class="badge" :class="statusBadge(s)" x-text="statusLabel(s)"></span></td>
                <td x-text="formatDate(s.next_run)"></td>
                <td x-text="formatDate(s.last_run)"></td>
                <td style="white-space:nowrap">
                  <button class="btn-sm" @click="edit(s)">Edit</button>
                  <button class="btn-sm" @click="toggle(s)" x-text="s.enabled ? 'Disable' : 'Enable'"></button>
                  <button class="btn-sm" @click="runNow(s)">Run</button>
                  <button class="btn-sm danger" @click="remove(s)">Delete</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>
    </div>
  </div>

  <!-- History -->
  <div class="view" x-show="$store.app.view === 'history'" x-data="historyView" x-cloak>
    <div class="view-scroll" style="display:flex;gap:16px">
      <!-- Conversation list -->
      <div style="width:280px;flex-shrink:0">
        <div class="section-header"><h2>Sessions</h2></div>
        <template x-if="loading">
          <div class="empty-state"><span class="spinner"></span></div>
        </template>
        <template x-if="!loading && conversations.length === 0">
          <div class="empty-state">No sessions found</div>
        </template>
        <div class="turn-list">
          <template x-for="conv in conversations" :key="conv.user_id + conv.agent">
            <div class="turn-item" :class="{ active: selectedConv?.user_id === conv.user_id }"
                 @click="selectConversation(conv)">
              <div x-text="conv.label"></div>
              <div class="turn-meta" x-text="conv.created_at ? formatDate(conv.created_at) : ''"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Turn detail -->
      <div style="flex:1;min-width:0">
        <template x-if="!selectedConv">
          <div class="empty-state">Select a session to view history</div>
        </template>
        <template x-if="selectedConv && turns.length === 0">
          <div class="empty-state">No turns in this session</div>
        </template>
        <template x-if="selectedConv && turns.length > 0">
          <div style="display:flex;flex-direction:column;gap:12px">
            <template x-for="(turn, i) in turns" :key="i">
              <div>
                <template x-if="turn.type === 'compaction'">
                  <div class="history-sep">
                    <template x-if="turn.summary">
                      <details>
                        <summary>session compacted</summary>
                        <div class="msg agent compaction-body" x-html="renderHtml(turn.summary)"></div>
                      </details>
                    </template>
                    <template x-if="!turn.summary"><span>session compacted</span></template>
                  </div>
                </template>
                <template x-if="turn.type !== 'compaction'">
                  <div>
                    <template x-if="turn.user">
                      <div class="msg user" x-html="renderHtml(turn.user)"></div>
                    </template>
                    <template x-if="extractMessages(turn).length > 0">
                      <div class="tool-calls-section">
                        <details>
                          <summary class="tool-calls-summary">
                            <span x-text="(() => { const calls = extractMessages(turn).filter(m => m.type === 'tool_call'); const n = calls.length; const label = calls.some(m => m.name === 'code') ? 'code execution' : 'tool call'; return n + ' ' + label + (n !== 1 ? 's' : ''); })()"></span>
                          </summary>
                          <template x-for="(m, mi) in extractMessages(turn)" :key="mi">
                            <div class="tool-call-item">
                              <template x-if="m.type === 'tool_call'">
                                <details>
                                  <summary class="tool-call-name"><span class="badge badge-accent" x-text="m.name === 'code' ? 'Code' : m.name"></span></summary>
                                  <pre class="tool-call-args" x-text="m.args"></pre>
                                </details>
                              </template>
                              <template x-if="m.type === 'tool_result'">
                                <details>
                                  <summary class="tool-result-name">Result<template x-if="m.name"> (<span x-text="m.name"></span>)</template></summary>
                                  <pre class="tool-call-args" x-text="m.content"></pre>
                                </details>
                              </template>
                            </div>
                          </template>
                        </details>
                      </div>
                    </template>
                    <template x-if="turn.assistant">
                      <div class="msg agent" x-html="renderHtml(turn.assistant)"></div>
                    </template>
                    <template x-if="turn.timestamp">
                      <div style="text-align:right;font-size:11px;color:var(--muted);margin-top:2px" x-text="formatDate(turn.timestamp)"></div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Webhooks -->
  <div class="view" x-show="$store.app.view === 'webhooks'" x-data="webhookView" x-cloak>
    <div class="view-scroll">
      <div class="section-header">
        <h2>Webhooks</h2>
        <button class="btn-sm" @click="showForm = !showForm" x-text="showForm ? 'Cancel' : '+ New'"></button>
      </div>

      <template x-if="error">
        <div class="msg error" x-text="error" style="margin-bottom:16px"></div>
      </template>

      <template x-if="showForm">
        <div class="card" style="margin-bottom:16px">
          <div class="form-row">
            <div class="form-group">
              <label>Agent</label>
              <select x-model="form.agent">
                <option value="">Select agent...</option>
                <template x-for="a in $store.app.agents" :key="a.name">
                  <option :value="a.name" x-text="a.name"></option>
                </template>
              </select>
            </div>
            <div class="form-group">
              <label>Source</label>
              <input x-model="form.source" placeholder="github, stripe, etc.">
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-cancel" @click="showForm = false">Cancel</button>
            <button class="btn-primary" @click="create()">Create</button>
          </div>
        </div>
      </template>

      <template x-if="loading">
        <div class="empty-state"><span class="spinner"></span> Loading...</div>
      </template>

      <template x-if="!loading && webhooks.length === 0 && !showForm">
        <div class="empty-state">No webhooks configured</div>
      </template>

      <template x-if="!loading && webhooks.length > 0">
        <table class="data-table">
          <thead><tr><th>Source</th><th>Agent</th><th>URL</th><th>Token</th><th>Actions</th></tr></thead>
          <tbody>
            <template x-for="w in webhooks" :key="w.token">
              <tr>
                <td><span class="badge badge-accent" x-text="w.source"></span></td>
                <td x-text="w.agent"></td>
                <td><code style="font-size:12px" x-text="webhookUrl(w.token)"></code></td>
                <td>
                  <span class="token-masked" x-text="isRevealed(w.token) ? w.token : maskedToken(w.token)"></span>
                  <span class="token-reveal" @click="toggleReveal(w.token)" x-text="isRevealed(w.token) ? 'hide' : 'show'"></span>
                </td>
                <td><button class="btn-sm danger" @click="remove(w)">Delete</button></td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>
    </div>
  </div>
</main>

<!-- Settings modal -->
<div class="modal-backdrop" :class="{ open: $store.app.showSettings }" @click.self="$store.app.showSettings = false"
     x-data="{ token: '', userId: '', tempTheme: '' }"
     x-effect="if ($store.app.showSettings) { token = localStorage.getItem('tsugite_token') || ''; userId = $store.app.userId; tempTheme = $store.app.theme; }">
  <div class="modal-content">
    <h2>Settings</h2>
    <label>API Token</label>
    <input type="password" x-model="token" placeholder="Bearer token (leave empty if no auth)">
    <label>User ID</label>
    <input type="text" x-model="userId" placeholder="web-user-1">
    <label>Theme</label>
    <select x-model="tempTheme" @change="$store.app.theme = tempTheme">
      <option value="latte">Latte</option>
      <option value="frappe">Frappé</option>
      <option value="macchiato">Macchiato</option>
      <option value="mocha">Mocha</option>
    </select>
    <div class="modal-actions">
      <button class="btn-cancel" @click="$store.app.theme = localStorage.getItem('tsugite_theme') || 'frappe'; $store.app.showSettings = false">Cancel</button>
      <button class="btn-primary" @click="
        if (token.trim()) localStorage.setItem('tsugite_token', token.trim()); else localStorage.removeItem('tsugite_token');
        $store.app.userId = userId.trim() || 'web-user-1';
        localStorage.setItem('tsugite_user_id', $store.app.userId);
        localStorage.setItem('tsugite_theme', tempTheme);
        $store.app.theme = tempTheme;
        $store.app.showSettings = false;
      ">Save</button>
    </div>
  </div>
</div>

</body>
</html>
